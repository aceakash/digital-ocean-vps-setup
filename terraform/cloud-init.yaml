#cloud-config
users:
  - name: ${username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: docker,sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - ${ssh_authorized_key}

disable_root: true
ssh_pwauth: false

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release

write_files:
  - path: /opt/caddy/Caddyfile
    permissions: '0644'
    content: |
      {
        acme_dns digitalocean ${digitalocean_token}
        email admin@untilfalse.com
        storage file_system /data
        log {
          level INFO
        }
      }

      (header_common) {
        header {
          Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
          X-Frame-Options "DENY"
          X-Content-Type-Options "nosniff"
          Referrer-Policy "strict-origin-when-cross-origin"
          Permissions-Policy "geolocation=(), microphone=(), camera=()"
          Content-Security-Policy "default-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; upgrade-insecure-requests"
          Cache-Control "public, max-age=300"
        }
      }

      # Serve static landing page for both bare and www host (wildcard cert covers *.untilfalse.com)
      untilfalse.com, www.untilfalse.com {
        import header_common
        root * /srv/static
        encode gzip zstd
        @index path /
        rewrite @index /index.html
        file_server
        respond /healthz 200
      }

  - path: /opt/caddy/docker-compose.yml
    permissions: '0644'
    content: |
      services:
        caddy:
          image: ${caddy_image}
          container_name: caddy
          restart: unless-stopped
          env_file: /opt/caddy/.env
          volumes:
            - /opt/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
            - /opt/caddy/site:/srv/static:ro
            - caddy_data:/data
            - caddy_config:/config
          ports:
            - "80:80"
            - "443:443"
          networks:
            - proxy
      networks:
        proxy:
          name: proxy
          driver: bridge
      volumes:
        caddy_data:
        caddy_config:

  - path: /opt/caddy/.env
    permissions: '0600'
    content: |
      DIGITALOCEAN_TOKEN=${digitalocean_token}

  - path: /opt/caddy/site/index.html
    permissions: '0644'
    content: |
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="utf-8" />
        <title>untilfalse.com</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; upgrade-insecure-requests">
        <style>
          body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 3rem auto; max-width: 52ch; line-height: 1.5; padding: 0 1rem; }
          h1 { font-size: 2rem; margin-bottom: 0.5rem; }
          code { background: #f4f4f4; padding: 0 .25em; border-radius: 4px; }
        </style>
      </head>
      <body>
        <h1>untilfalse.com</h1>
        <p>Static landing page served by Caddy with DNS-01 TLS (DigitalOcean). Wildcard/host certificates are managed automatically.</p>
        <p>Page provisioned automatically by cloud-init.</p>
      </body>
      </html>

  - path: /usr/local/bin/caddy-compose-up.sh
    permissions: '0755'
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      if [ ! -f /opt/caddy/.env ]; then
        echo "[caddy-compose-up] /opt/caddy/.env missing; skipping start."
        exit 0
      fi
      echo "[caddy-compose-up] Starting Caddy compose stack..."
      /usr/bin/docker compose -f /opt/caddy/docker-compose.yml up -d
      /usr/bin/docker logs caddy | head -n 40 || true

  - path: /etc/systemd/system/caddy-compose.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Caddy static site via docker compose
      Requires=docker.service
      After=docker.service

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/caddy-compose-up.sh
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

runcmd:
  - [ sh, -c, "set -eux" ]
  - [ sh, -c, "curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh" ]
  - [ sh, -c, "mkdir -p /etc/docker" ]
  - [ sh, -c, "cat > /etc/docker/daemon.json <<'EOF'\n{ \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"10m\", \"max-file\": \"150\" } }\nEOF" ]
  - [ sh, -c, "systemctl enable --now docker" ]
  - [ sh, -c, "apt-get update && apt-get install -y docker-compose-plugin fail2ban unattended-upgrades" ]
  - [ sh, -c, "ufw allow 22 && ufw allow 80 && ufw allow 443 && ufw --force enable" ]
  - [ sh, -c, "systemctl enable --now fail2ban" ]
  - [ sh, -c, "dpkg-reconfigure -f noninteractive unattended-upgrades" ]
  - [ sh, -c, "usermod -aG docker ${username}" ]
  - [ sh, -c, "mkdir -p /opt/caddy/site" ]
  - [ sh, -c, "systemctl daemon-reload" ]
  - [ sh, -c, "systemctl enable --now caddy-compose.service" ]

final_message: "Cloud-init finished. Docker + basic hardening configured."
