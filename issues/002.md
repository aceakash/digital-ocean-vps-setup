# Issue 002: Deploy First External Web App Behind Caddy

## Goal

Run existing stateless web app container on the droplet and expose it at vocab.untilfalse.com via Caddy (wildcard cert already in place).

## Scope

No Terraform changes (wildcard DNS covers subdomain). Add container + Caddy route. Keep DO token handling as-is (embedded) for now.

## Approach (Option A: inline compose)

Add service to existing `/opt/caddy/docker-compose.yml`, join `proxy` network, no published ports, Caddy reverse_proxy to internal port.

(Option B deferred: dedicated directory `/opt/apps/vocab/docker-compose.yml`.)

## Steps

1. Image exists in GHCR (e.g. `ghcr.io/aceakash/vocab:0.1.0`).
2. SSH to droplet as `akash`.
3. Edit `/opt/caddy/docker-compose.yml`: add service block.
4. Append site block for vocab.untilfalse.com to `/opt/caddy/Caddyfile` (see snippet).
5. `docker compose -f /opt/caddy/docker-compose.yml pull vocab`
6. `docker compose -f /opt/caddy/docker-compose.yml up -d vocab`
7. Reload Caddy: `docker compose -f /opt/caddy/docker-compose.yml exec caddy caddy reload --config /etc/caddy/Caddyfile`
8. Test: `curl -I https://vocab.untilfalse.com/health` (or main path).
9. Update functional requirements + Copilot instructions (dynamic apps section).
10. (Optional) Add Watchtower label later when auto-update policy enabled.

## Compose Service Snippet (example)

```yaml
vocab:
  image: ghcr.io/aceakash/vocab:0.1.0
  container_name: vocab
  restart: unless-stopped
  environment:
    APP_LOG_LEVEL: info
  networks:
    - proxy
  labels:
    com.centurylinklabs.watchtower.enable: "true" # enable once watchtower label gating adopted
```

## Caddyfile Site Snippet

```caddy
vocab.untilfalse.com {
    encode zstd gzip
    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self';"
    }
    reverse_proxy vocab:8080
    log {
        output file /var/log/caddy/vocab.access.log
        format json
    }
}
```

## Rollback

Remove service + site block, reload Caddy, `docker compose rm -f vocab`.

## Risks

- Memory pressure (512MB droplet).
- Using moving tags risks silent breakage (prefer semver).
- Limited observability.

## Next After Completion

- Introduce Watchtower container.
- Begin secret hygiene (remove DO token from user_data).
- Define build-time vs runtime secret list.
- Add remote Terraform state.

## Checklist

- [ ] Add compose service.
- [ ] Add Caddy site block.
- [ ] Deploy container.
- [ ] Validate HTTPS & headers.
- [ ] Update documentation.
- [ ] Plan Watchtower integration.

## Acceptance

HTTPS at vocab.untilfalse.com returns app response with headers; no extra open ports; Caddy reload succeeds.
